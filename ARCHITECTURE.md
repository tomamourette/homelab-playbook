# homelab-playbook Architecture

**Last Updated:** 2026-02-05  
**Status:** Active Development (MVP Phase)

## Purpose

homelab-playbook is an **orchestration layer** that coordinates BMAD methodology with AI agents to generate infrastructure-as-code. It does NOT replace existing infrastructure - it enhances the development workflow.

## Repository Structure

### Three-Repo Model

```
homelab-playbook/          ← Orchestration & Planning (this repo)
├── _bmad/                 ← BMAD workflow definitions
├── _bmad-output/          ← Generated planning artifacts
│   ├── planning-artifacts/    ← Product Brief, PRD, Architecture
│   └── implementation-artifacts/  ← Stories for Claude Code CLI
├── management/            ← Project tracking
├── openclaw/              ← OpenClaw config docs (delegation, routing, cost)
├── patterns/              ← Convention documentation
└── skills/                ← 33 BMAD skill definitions (SKILL.md files)

homelab-infra/             ← Infrastructure Provisioning (target repo)
├── terraform/             ← VM/CT creation via Proxmox provider
├── ansible/               ← Host-level configuration
└── packer/                ← Template building

homelab-apps/              ← Application Deployment (target repo)
├── stacks/                ← Docker Compose stacks
│   ├── dns-pihole/
│   ├── media-plex/
│   └── ...
└── terraform/             ← Portainer stack deployment
```

## Component Responsibilities

### homelab-playbook (This Repo)
- **Owner:** OpenClaw (Supervisor)
- **Purpose:** BMAD workflow coordination, planning artifact storage
- **Outputs:**
  - Product Briefs (`_bmad-output/planning-artifacts/`)
  - PRDs (`_bmad-output/planning-artifacts/`)
  - Architecture documents (`_bmad-output/planning-artifacts/`)
  - Implementation stories (`_bmad-output/implementation-artifacts/`)
- **Does NOT contain:** Actual infrastructure code (Terraform, Ansible, Docker Compose)

### homelab-infra (Target Repo)
- **Owner:** Generated by Claude Code CLI, reviewed by Larry
- **Purpose:** VM/CT provisioning and host-level configuration
- **Generated artifacts:**
  - Terraform modules (new VMs/CTs)
  - Ansible playbooks and roles (host setup, package install)
  - Configuration files for infrastructure

### homelab-apps (Target Repo)
- **Owner:** Generated by Claude Code CLI, reviewed by Larry
- **Purpose:** Containerized application stacks
- **Generated artifacts:**
  - Docker Compose stacks (`stacks/<service-name>/docker-compose.yml`)
  - Environment templates (`.env.sample`)
  - Stack configuration files

## Development Workflow

### Current (Manual)
```
Larry ──→ VS Code ──→ Manual IaC coding ──→ Git commit ──→ GitOps deploy
```

### New (BMAD-Orchestrated)
```
Larry ──→ Telegram ──→ OpenClaw (BMAD agent, Gemini Pro — free)
                              │
                              ├─ Phase 1-2: Local planning (Gemini Pro)
                              │   → _bmad-output/planning-artifacts/
                              │
                              ├─ Phase 3-4: Delegate via exec
                              │   → Claude CLI (Opus 4.6, Max subscription)
                              │   → Generate IaC in target repo
                              │   → Create branch + PR
                              │
                              └─ Larry ──→ Review PR ──→ Merge ──→ GitOps deploy
                                                        (Portainer/Ansible unchanged)
```

## Agent Roles

### OpenClaw (Supervisor)
- **Agent:** BMAD Orchestrator (`bmad` agent on Gemini Pro — free via OAuth)
- **Location:** Runs in `homelab-playbook/` context
- **Skills:** 33 BMAD skills in `skills/` (27 local, 6 delegated to Claude CLI)
- **Responsibilities:**
  - Execute BMAD planning workflows (Product Brief, PRD, Architecture, Stories)
  - Delegate dev work to Claude CLI via `exec` tool
  - Coordinate workflow progression
  - Maintain topology awareness (node inventory, service registry)

### Claude Code CLI (Worker)
- **Agent:** Claude CLI headless mode (`-p` flag), Opus 4.6 via Max subscription
- **Location:** Spawned in target repo (`homelab-infra/` or `homelab-apps/`)
- **Delegated tasks:** Architecture, impl. readiness, dev story, code review, quick dev (5 of 27 skills)
- **Responsibilities:**
  - Receive story spec + architecture context from OpenClaw (via `exec`)
  - Generate IaC code (Terraform, Ansible, Docker Compose)
  - Read CLAUDE.md for project conventions automatically
  - Follow existing patterns and conventions
  - Create git branch + commits
  - Open Pull Request with implementation

## Repository Routing Logic

### When to target homelab-infra:
- New VM or LXC container needed (Terraform module)
- Host-level configuration (Ansible role/playbook)
- Network or storage infrastructure changes

### When to target homelab-apps:
- New Docker Compose stack
- Modifications to existing stack
- Service-level configuration

### When changes span both repos:
- Generate separate PRs in each repo
- PRs cross-reference each other
- Document deployment order (infra first, then apps)

## Context Passing

### What Claude Code CLI needs to know:
1. **Story Specification** - From `_bmad-output/implementation-artifacts/story-*.md`
2. **Architecture Decisions** - From `_bmad-output/planning-artifacts/architecture.md`
3. **Pattern Library** - From `homelab-playbook/patterns/` (Traefik conventions, `.env` structure)
4. **Existing Code Examples** - Reference stacks from target repo
5. **Topology Registry** - Node inventory, service locations (planned feature)

### How context is passed:
- OpenClaw spawns Claude Code CLI session
- Passes story file path + architecture doc + pattern references
- Claude Code CLI reads context, generates code
- Returns PR link to OpenClaw for Larry's review

## GitOps Integration (Unchanged)

homelab-playbook does NOT modify existing deployment automation:

### homelab-apps → Portainer GitOps
- Merge to `main` → Portainer webhooks trigger
- Changed stacks redeploy automatically
- Status visible in Portainer GUI

### homelab-infra → Manual/GitHub Actions
- Terraform: Run `terraform apply` from dev-vm
- Ansible: Run playbooks via `ansible-playbook`
- VM/CT creation visible in Proxmox

**homelab-playbook's role:** Generate correct IaC, submit PR, let existing automation handle deployment.

## Success Criteria (MVP)

homelab-playbook MVP is validated when:

1. ✅ OpenClaw executes full BMAD workflow (Brief → PRD → Architecture → Stories)
2. ✅ Claude Code CLI generates IaC for one reference service (Pi-hole)
3. ✅ Generated code passes Larry's PR review (follows conventions, includes Day 2 integration)
4. ✅ PR merge → GitOps deploys service successfully
5. ✅ Larry successfully reverts a bad config via `git revert`

**Reference implementation:** Deploy Pi-hole with:
- Docker Compose stack in `homelab-apps/stacks/dns-pihole/`
- Traefik ingress + Let's Encrypt TLS
- Authentik SSO (if applicable)
- Prometheus metrics (if available)
- Restic backup config

## Future Enhancements

### Phase 2 (Growth):
- **Topology Registry** - Automated service/node tracking
- **Operator Mode** - Quick CLI troubleshooting commands
- **Drift Detection** - Automated config drift monitoring

### Phase 3 (Vision):
- **Community Patterns** - Shareable BMAD-validated deployments
- **Multi-Service Orchestration** - Deploy complex stacks (full *arr suite)
- **AI-Driven Optimization** - Resource utilization recommendations

## Related Documents

- [openclaw/claude-cli-delegation.md](openclaw/claude-cli-delegation.md) — How OpenClaw delegates to Claude CLI
- [openclaw/bmad-pipeline.md](openclaw/bmad-pipeline.md) — Full BMAD workflow map with model routing
- [openclaw/model-routing-strategy.md](openclaw/model-routing-strategy.md) — Model inventory and task matrix
- [openclaw/cost-optimization.md](openclaw/cost-optimization.md) — Cost optimization guide

## Key Insight

homelab-playbook is NOT infrastructure. It's the **methodology layer** that makes "doing infrastructure right" easier than "doing it quick" by leveraging AI agents to absorb the process overhead.
